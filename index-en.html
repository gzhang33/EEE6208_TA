<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Review Sprint</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Global Styles and Design Philosophy --- */
        :root {
            --bg-color: #fdfbf7; /* Cream background */
            --text-color: #333333; /* Dark gray text */
            --primary-color: #4a5568; /* Theme color/navigation background */
            --accent-color: #718096; /* Secondary color/hover effects */
            --border-color: #e2e8f0; /* Border color */
            --highlight-bg: #fff9c4; /* Highlight background color */
            --code-bg: #f7fafc; /* Code/formula background */
            --mastered-color: #48bb78; /* Mastered */
            --review-color: #f6ad55; /* Need review */
            --confused-color: #f56565; /* Confused */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            scroll-behavior: smooth;
        }

        /* --- Website Structure and Layout --- */
        .container {
            display: flex;
        }

        /* Left fixed navigation bar */
        .sidebar {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
            /* Hidden by default */
            transform: translateX(-100%);
            transition: transform 0.4s ease-in-out;
        }
        
        /* JS controls this class to show sidebar */
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav li a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        /* Highlight main chapter titles */
        .sidebar nav li a[href="#analogue-electronics"],
        .sidebar nav li a[href="#digital-electronics"] {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 700;
            font-size: 1.1em;
            margin: 10px 0;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar nav li a[href="#analogue-electronics"]:hover,
        .sidebar nav li a[href="#digital-electronics"]:hover {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
            color: white;
        }
        
        .sidebar nav li a:hover {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            transform: translateX(3px);
            box-shadow: 0 3px 12px rgba(72, 187, 120, 0.3);
        }
        
        .sidebar nav li a.active {
            background-color: var(--accent-color);
        }
        
        .sidebar nav .sub-menu {
            padding-left: 20px;
        }
        
        .sidebar nav .sub-menu li a {
            font-size: 0.9em;
            padding: 8px 15px;
        }

        /* Main content area */
        .main-content {
            margin-left: 0;
            width: 100%;
            padding: 40px;
            transition: margin-left 0.4s ease-in-out;
        }
        
        .main-content h1 {
            font-size: 2.8em;
            color: var(--primary-color);
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 15px;
            margin-top: 0;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content h2 {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-top: 60px;
            padding: 20px 0 15px 0;
            border-bottom: 2px solid var(--accent-color);
            position: relative;
            font-weight: 600;
        }
        
        .main-content h2::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-color) 0%, transparent 100%);
            border-radius: 2px;
        }
        
        .main-content h3 {
            font-size: 1.6em;
            color: var(--primary-color);
            margin-top: 40px;
            padding: 12px 0 8px 0;
            border-left: 3px solid var(--accent-color);
            padding-left: 15px;
            background: linear-gradient(90deg, rgba(113, 128, 150, 0.05) 0%, transparent 50%);
            font-weight: 600;
        }
        
        /* --- Content Presentation Styles --- */
        strong, .highlight {
            background-color: var(--highlight-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            border-left: 2px solid var(--accent-color);
            padding-left: 8px;
        }
        
        /* h4 title styles */
        .main-content h4 {
            color: var(--accent-color);
            font-size: 1.3em;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 1px dotted var(--accent-color);
        }
        
        code, .formula-block {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            font-family: 'Courier New', monospace;
            display: block;
            margin: 15px 0;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .formula-block {
            text-align: center;
            font-size: 1.1em;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        }
        
        /* --- Interactive Elements --- */
        .collapsible {
            cursor: pointer;
            color: var(--accent-color);
            font-weight: 600;
            border-bottom: 1px dashed var(--accent-color);
        }
        
        .collapsible:hover {
            color: var(--primary-color);
        }
        
        .collapsible-icon {
            font-weight: bold;
            margin-right: 5px;
        }
        
        .collapsible-content {
            display: none;
            padding: 10px;
            margin: 10px 0;
            background-color: var(--highlight-bg);
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
        }
        
        /* Mastery controls */
        .mastery-controls {
            display: inline-block;
            margin-left: 15px;
        }
        
        .mastery-icon {
            cursor: pointer;
            font-size: 1.2em;
            margin: 0 3px;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .mastery-icon:hover {
            transform: scale(1.2);
        }
        
        .mastery-icon.selected[data-level="mastered"] {
            background-color: var(--mastered-color);
            color: white;
        }
        
        .mastery-icon.selected[data-level="review"] {
            background-color: var(--review-color);
            color: white;
        }
        
        .mastery-icon.selected[data-level="confused"] {
            background-color: var(--confused-color);
            color: white;
        }
        
        /* Quiz section */
        .quiz-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }
        
        .quiz-button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 0;
        }
        
        .quiz-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }
        
        .quiz-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: var(--code-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .quiz-item {
            margin: 15px 0;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
        }
        
        .show-answer-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 0.9em;
        }
        
        .quiz-answer {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: var(--highlight-bg);
            border-radius: 4px;
            border-left: 2px solid var(--accent-color);
        }
        
        .quiz-refresh-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            float: right;
        }
        
        /* Quiz terms */
        .quiz-term {
            color: var(--accent-color);
            font-weight: 600;
            border-bottom: 1px dotted var(--accent-color);
        }
        
        .quiz-definition {
            background-color: var(--highlight-bg);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 5px 0;
            border-left: 3px solid var(--accent-color);
        }
        
        /* Sidebar trigger strip */
        .sidebar-trigger-strip {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            z-index: 999;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .sidebar-trigger-strip:hover {
            width: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        }
        
        /* Back to top button */
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            color: white;
            text-decoration: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .back-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        /* Language switcher */
        .language-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 10px;
        }
        
        .language-switcher a {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 5px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .language-switcher a.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .language-switcher a:not(.active) {
            background-color: var(--border-color);
            color: var(--text-color);
        }
        
        .language-switcher a:hover:not(.active) {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .main-content h1 {
                font-size: 2em;
            }
            
            .main-content h2 {
                font-size: 1.8em;
            }
            
            .main-content h3 {
                font-size: 1.4em;
            }
        }
        
        @media (min-width: 769px) {
            .sidebar.open + .main-content {
                margin-left: 280px;
            }
        }
    </style>
</head>
<body>

    <!-- Language Switcher -->
    <div class="language-switcher">
        <a href="index-en.html" class="active">EN</a>
        <a href="index-zh.html">ä¸­æ–‡</a>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">Digital & Analogue TA</div>
            <nav id="table-of-contents"></nav>
        </aside>

        <!-- Left touch strip -->
        <div class="sidebar-trigger-strip" id="sidebar-trigger-strip">â˜°</div>

        <main class="main-content" id="main-content-area">
            <h1>Digital & Analogue<br/>TA Review</h1>

            <!-- Note content will be dynamically inserted here by JS -->

        </main>
    </div>

    <!-- Back to top button -->
    <a href="#" class="back-to-top" id="back-to-top-btn">â†‘</a>

    <script>
    // ---------------------------------------------------------------
    // ---------------------- Note Content Data Source -------------------------
    // ---------------------------------------------------------------
    const notesContent = `
    <div class="section-container active" id="analogue-container">
    <section id="analogue-electronics" class="quiz-section">
        <h2>Analogue Electronics</h2>
        <section id="mosfet-operating-states-output-voltage-swing">
            <h3>MOSFET Operating States & Output Voltage Swing <div class="mastery-controls" data-id="mosfet-operating-states-output-voltage-swing"><span class="mastery-icon" data-level="mastered">ðŸ˜Š</span><span class="mastery-icon" data-level="review">ðŸ¤”</span><span class="mastery-icon" data-level="confused">ðŸ¤¯</span></div></h3>
            <p>MOSFET has three basic operating states:</p>
            <ul>
                <li><strong>Off State</strong> - Like a turned-off switch, no current flows</li>
                <li><strong>Linear State</strong> - Like an adjustable resistor, current controlled by gate voltage</li>
                <li><strong>Saturation State</strong> - Like a stable current source, provides fixed current</li>
            </ul>
            <p><strong>Note</strong>: In saturation state, there exists <span class="collapsible"><span class="collapsible-icon">[+]</span>Channel Length Modulation</span><span class="collapsible-content">which causes current to increase slightly when drain voltage increases.</span> The current formula is as follows:</p>
            <div class="formula-block">$$ I_D = \\frac{1}{2} \\mu_n C_{\\text{ox}} \\frac{W}{L} (V_{GS} - V_T)^2 (1 + \\lambda V_{DS}) $$</div>
            <p><span class="collapsible"><span class="collapsible-icon">[+]</span>Output Voltage Swing</span><span class="collapsible-content">is defined as the maximum voltage range when all transistors maintain saturation region operation:</span></p>
            <ul>
                <li><strong>Upper Limit (Vout,max)</strong>: Limited by PMOS load transistor entering triode region, approximately VDDâˆ’âˆ£VOV,loadâˆ£</li>
                <li><strong>Lower Limit (Vout,min)</strong>: Limited by NMOS pair or tail current source transistor entering triode region, approximately VOV,input+VOV,tail</li>
            </ul>
        </section>
        <section id="basic-principles-of-differential-amplifiers">
            <h3>Basic Principles of Differential Amplifiers <div class="mastery-controls" data-id="basic-principles-of-differential-amplifiers"><span class="mastery-icon" data-level="mastered">ðŸ˜Š</span><span class="mastery-icon" data-level="review">ðŸ¤”</span><span class="mastery-icon" data-level="confused">ðŸ¤¯</span></div></h3>
            <h4>1. <span class="quiz-term">Differential Mode (A_dm)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="How does differential mode (A_dm) work?"><strong>Working Principle</strong>: The common source point of the two transistors in a differential amplifier can be regarded as "virtual ground" because the circuit is symmetrical.</span></li>
                <li><span class="quiz-definition" data-term="What is the simplified analysis method for differential mode (A_dm)?"><strong>Simplified Analysis Method</strong>: We can analyze only half of the circuit, treating it as a simple common-source amplifier for easier calculation.</span></li>
                <li><strong>Amplification Capability</strong>:
                    <ul>
                        <li><span class="quiz-definition" data-term="What is 'single-ended output gain'?">When we look at only one output, this is called "single-ended output gain".</span></li>
                        <li><span class="quiz-definition" data-term="What is 'differential output gain'?">When we look at the voltage difference between two outputs, this is called "differential output gain". Typically, differential output gain is twice the single-ended output gain.</span></li>
                    </ul>
                </li>
            </ul>
            <h4>2. <span class="quiz-term">Common Mode (A_cm)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="How does common mode (A_cm) work?"><strong>Working Principle</strong>: When both inputs receive the same signal (common mode signal), the tail current source resistance plays an important role. This resistance produces negative feedback effect, helping to suppress common mode signals.</span></li>
                <li><span class="quiz-definition" data-term="How effective is common mode (A_cm) suppression?"><strong>Suppression Effect</strong>: The amplifier greatly attenuates common mode signals, which is exactly what we want.</span></li>
                <li><span class="quiz-definition" data-term="How does common mode (A_cm) perform in differential output?"><strong>Performance in Differential Output</strong>: When we look at the difference between two outputs, ideally the common mode signal is completely eliminated (gain is zero). This is because common mode signals produce identical changes at both ends.</span></li>
            </ul>
            <h4>3. <span class="quiz-term">Common Mode Rejection Ratio (CMRR)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="What does Common Mode Rejection Ratio (CMRR) mean?"><strong>Meaning</strong>: CMRR is used to measure the quality of an amplifier, indicating the ratio of the amplifier's ability to amplify useful signals (differential signals) to its ability to suppress interference signals (common mode signals).</span></li>
            </ul>
            <div class="formula-block">$$ CMRR=\\left|\\frac{A_{dm}}{A_{cm}}\\right| $$</div>
            <ul>
                 <li><span class="quiz-definition" data-term="What do CMRR performance indicators represent?"><strong>Performance Indicators</strong>: The larger the CMRR, the better the performance. Especially in differential output, because common mode signals are completely suppressed, theoretically CMRR can reach infinity.</span></li>
            </ul>
            <h4>Role of Two Key Transistors in Amplifier</h4>
            <ul>
                <li><span class="quiz-definition" data-term="What is the role of M1 transistor in the amplifier?"><strong>M1's Work: Signal Amplifier</strong> M1 is responsible for receiving and amplifying input signals. It acts like a voltage-controlled switch, regulating current magnitude based on input voltage changes. M1's transconductance (gm1) determines how much current change it can convert from small voltage changes.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of M3 transistor in the amplifier?"><strong>M3's Work: Current Converter</strong> M3's task is to convert current changes produced by M1 into voltage changes. Its gate voltage is fixed, mainly providing a large output resistance. This large resistance helps us obtain larger output voltage signals.</span></li>
            </ul>
        </section>
        <section id="miller-effect">
            <h3>Miller Effect <div class="mastery-controls" data-id="miller-effect"><span class="mastery-icon" data-level="mastered">ðŸ˜Š</span><span class="mastery-icon" data-level="review">ðŸ¤”</span><span class="mastery-icon" data-level="confused">ðŸ¤¯</span></div></h3>
            <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Miller Effect</span></span><span class="collapsible-content quiz-definition" data-term="Explain Miller Effect">In inverting amplifiers, the input-output capacitance (such as Cgd in CS amplifiers) appears as a larger capacitance at the input Cin,Miller=Cf(1âˆ’A_v), because Av is a large negative number.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Input Pole</span></span><span class="collapsible-content quiz-definition" data-term="Explain Input Pole">Amplifier frequency response is limited by poles formed by RC networks, frequency fp=1/(2Ï€R_totalC_total).</span></li>
                <li><span class="quiz-definition" data-term="Why are common-source amplifiers affected by Miller effect?"><strong>Common Source (CS) Amplifier</strong>: Gate-drain Cgd capacitance causes significant Miller effect, forming the <strong>dominant pole</strong> that limits bandwidth.</span></li>
                <li><span class="quiz-definition" data-term="Why do common-gate amplifiers have no Miller effect?"><strong>Common Gate (CG) Amplifier</strong>: Input at source, output at drain, gate grounded, no input-output capacitance, therefore <strong>no Miller effect</strong>, high-frequency characteristics superior to CS.</span></li>
            </ul>
        </section>
        <section id="negative-feedback">
            <h3>Negative Feedback <div class="mastery-controls" data-id="negative-feedback"><span class="mastery-icon" data-level="mastered">ðŸ˜Š</span><span class="mastery-icon" data-level="review">ðŸ¤”</span><span class="mastery-icon" data-level="confused">ðŸ¤¯</span></div></h3>
            <ul>
                <li><span class="quiz-definition" data-term="Describe a type of negative feedback and its effect"><strong>Feedback Method</strong>: Series input parallel output, increases input resistance, decreases output resistance.</span></li>
            </ul>
            <h4>Identification of Positive and Negative Feedback</h4>
            <p>Determine feedback type by analyzing <strong>the effect of feedback signal on input</strong>:</p>
            <ul>
                <li><span class="quiz-definition" data-term="How to identify negative feedback?"><strong>Negative Feedback</strong>: Feedback signal opposes input signal, reducing overall gain but improving stability and linearity.</span></li>
                <li><span class="quiz-definition" data-term="How to identify positive feedback?"><strong>Positive Feedback</strong>: Feedback signal reinforces input signal, increasing gain but potentially causing instability and oscillation.</span></li>
            </ul>
        </section>
        <button class="quiz-button">Generate Chapter Quiz</button>
        <div class="quiz-container"></div>
    </section>
    </div>
    `;

    // ---------------------------------------------------------------
    // ---------------------- JavaScript Functionality -------------------------
    // ---------------------------------------------------------------
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Insert content
        document.getElementById('main-content-area').innerHTML += notesContent;
        
        // Initialize all functionality
        initializeSidebar();
        initializeCollapsible();
        initializeMasteryControls();
        initializeQuizButtons();
        initializeBackToTop();
        generateTableOfContents();
    });

    // Sidebar functionality
    function initializeSidebar() {
        const sidebar = document.getElementById('sidebar');
        const triggerStrip = document.getElementById('sidebar-trigger-strip');
        const mainContent = document.querySelector('.main-content');
        
        triggerStrip.addEventListener('click', function() {
            sidebar.classList.toggle('open');
        });
        
        // Close sidebar when clicking outside
        document.addEventListener('click', function(e) {
            if (!sidebar.contains(e.target) && !triggerStrip.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });
    }

    // Collapsible content functionality
    function initializeCollapsible() {
        const collapsibles = document.querySelectorAll('.collapsible');
        collapsibles.forEach(collapsible => {
            collapsible.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const icon = this.querySelector('.collapsible-icon');
                
                if (content.style.display === 'block') {
                    content.style.display = 'none';
                    icon.textContent = '[+]';
                } else {
                    content.style.display = 'block';
                    icon.textContent = '[-]';
                }
            });
        });
    }

    // Mastery controls functionality
    function initializeMasteryControls() {
        const masteryControls = document.querySelectorAll('.mastery-controls');
        masteryControls.forEach(control => {
            const icons = control.querySelectorAll('.mastery-icon');
            const id = control.dataset.id;
            
            // Load saved state
            const savedLevel = localStorage.getItem('mastery-' + id);
            if (savedLevel) {
                const savedIcon = control.querySelector(`[data-level="${savedLevel}"]`);
                if (savedIcon) {
                    savedIcon.classList.add('selected');
                }
            }
            
            icons.forEach(icon => {
                icon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const level = this.dataset.level;
                    icons.forEach(i => i.classList.remove('selected'));
                    if (localStorage.getItem('mastery-' + id) === level) {
                         localStorage.removeItem('mastery-' + id);
                    } else {
                        this.classList.add('selected');
                        localStorage.setItem('mastery-' + id, level);
                    }
                });
            });
        });
    }

    function initializeQuizButtons() {
        const quizButtons = document.querySelectorAll('.quiz-button');
        quizButtons.forEach(button => {
            // Initialize button state
            button.dataset.state = 'generate';
            
            button.addEventListener('click', function() {
                const section = this.closest('.quiz-section');
                const quizContainer = section.querySelector('.quiz-container');
                
                if (this.dataset.state === 'generate') {
                    // Generate quiz
                    generateQuizContent(section, this);
                    this.textContent = 'Close Quiz';
                    this.dataset.state = 'close';
                } else {
                    // Close quiz
                    quizContainer.style.display = 'none';
                    quizContainer.innerHTML = '';
                    this.textContent = 'Generate Chapter Quiz';
                    this.dataset.state = 'generate';
                }
            });
        });
    }

    function generateQuizContent(section, button) {
        const quizContainer = section.querySelector('.quiz-container');
        const terms = section.querySelectorAll('.quiz-definition');
        
        if (terms.length === 0) {
            quizContainer.innerHTML = `
                <button class="quiz-refresh-btn" title="Refresh Quiz">â†»</button>
                <h4>Chapter Self-Test</h4>
                <p>No quiz questions available for this chapter.</p>
            `;
            quizContainer.style.display = 'block';
            return;
        }

        const shuffledTerms = Array.from(terms).sort(() => 0.5 - Math.random());
        const selectedTerms = shuffledTerms.slice(0, Math.min(shuffledTerms.length, 5)); 

        let quizHtml = `
            <button class="quiz-refresh-btn" title="Refresh Quiz">â†»</button>
            <h4>Chapter Self-Test</h4>
        `;
        selectedTerms.forEach((term, index) => {
            const question = term.dataset.term || 'Please explain...';
            const answer = term.innerHTML;
            quizHtml += `
                <div class="quiz-item">
                    <p>${index + 1}. ${question}
                        <button class="show-answer-btn">Show Answer</button>
                    </p>
                    <div class="quiz-answer">${answer}</div>
                </div>
            `;
        });
        quizContainer.innerHTML = quizHtml;
        quizContainer.style.display = 'block';

        // Set up show answer button events
        quizContainer.querySelectorAll('.show-answer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const answerDiv = this.parentElement.nextElementSibling;
                answerDiv.style.display = 'block';
                this.style.display = 'none';
            });
        });

        // Set up refresh button event
        const refreshBtn = quizContainer.querySelector('.quiz-refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                generateQuizContent(section, button);
            });
        }
    }

    // Back to top functionality
    function initializeBackToTop() {
        const backToTopBtn = document.getElementById('back-to-top-btn');
        
        window.addEventListener('scroll', function() {
            if (window.pageYOffset > 300) {
                backToTopBtn.style.display = 'flex';
            } else {
                backToTopBtn.style.display = 'none';
            }
        });
        
        backToTopBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }

    // Generate table of contents
    function generateTableOfContents() {
        const toc = document.getElementById('table-of-contents');
        const sections = document.querySelectorAll('section[id]');
        
        let tocHtml = '<ul>';
        sections.forEach(section => {
            const id = section.id;
            const title = section.querySelector('h2, h3').textContent.split('<')[0]; // Remove mastery controls
            const level = section.querySelector('h2') ? 1 : 2;
            
            if (level === 1) {
                tocHtml += `</ul><ul><li><a href="#${id}">${title}</a>`;
            } else {
                tocHtml += `<ul class="sub-menu"><li><a href="#${id}">${title}</a></li></ul>`;
            }
        });
        tocHtml += '</ul>';
        
        toc.innerHTML = tocHtml;
        
        // Add smooth scrolling to anchor links
        toc.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const targetId = this.getAttribute('href').substring(1);
                const targetElement = document.getElementById(targetId);
                if (targetElement) {
                    targetElement.scrollIntoView({
                        behavior: 'smooth'
                    });
                }
            });
        });
    }
    </script>
</body>
</html>