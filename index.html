<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Review Sprint</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* --- Global Styles and Design Philosophy --- */
        :root {
            --bg-color: #fdfbf7;
            --text-color: #333333;
            --primary-color: #4a5568;
            --accent-color: #718096;
            --border-color: #e2e8f0;
            --highlight-bg: #fff9c4;
            --code-bg: #f7fafc;
            --mastered-color: #48bb78;
            --review-color: #f6ad55;
            --confused-color: #f56565;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            scroll-behavior: smooth;
        }
        .lang-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }
        .lang-switch button {
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 10px 18px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.2s;
        }
        .lang-switch button:hover {
            background: var(--accent-color);
        }
        /* --- Website Structure and Layout --- */
        .container {
            display: flex;
        }

        /* Left Fixed Navigation Bar */
        .sidebar {
            width: 280px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            overflow-y: auto;
            z-index: 1000;
            /* Default hidden */
            transform: translateX(-100%);
            transition: transform 0.4s ease-in-out;
        }
        
        /* JS controls this class to show sidebar */
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar nav li a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        /* Highlight main chapter titles */
        .sidebar nav li a[href="#analogue-electronics"],
        .sidebar nav li a[href="#digital-electronics"] {
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.08) 100%);
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 700;
            font-size: 1.1em;
            margin: 10px 0;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar nav li a[href="#analogue-electronics"]:hover,
        .sidebar nav li a[href="#digital-electronics"]:hover {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
            color: white;
        }
        
        .sidebar nav li a:hover {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            transform: translateX(3px);
            box-shadow: 0 3px 12px rgba(72, 187, 120, 0.3);
        }
        
        .sidebar nav li a.active {
            background-color: var(--accent-color);
        }
        
        .sidebar nav .sub-menu {
            padding-left: 20px;
        }
        
        .sidebar nav .sub-menu li a {
            font-size: 0.9em;
            padding: 8px 15px;
        }

        /* Main Content Area */
        .main-content {
            margin-left: 0;
            width: 100%;
            padding: 40px;
            transition: margin-left 0.4s ease-in-out;
        }
        
        .main-content h1 {
            font-size: 2.8em;
            color: var(--primary-color);
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 15px;
            margin-top: 0;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content h2 {
            font-size: 2.2em;
            color: var(--primary-color);
            margin-top: 60px;
            padding: 20px 0 15px 0;
            border-bottom: 2px solid var(--accent-color);
            position: relative;
            font-weight: 600;
        }
        
        .main-content h2::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-color) 0%, transparent 100%);
            border-radius: 2px;
        }
        
        .main-content h3 {
            font-size: 1.6em;
            color: var(--primary-color);
            margin-top: 40px;
            padding: 12px 0 8px 0;
            border-left: 3px solid var(--accent-color);
            padding-left: 15px;
            background: linear-gradient(90deg, rgba(113, 128, 150, 0.05) 0%, transparent 50%);
            font-weight: 600;
        }
        
        /* --- Content Presentation Styles --- */
        strong, .highlight {
            background-color: var(--highlight-bg);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            border-left: 2px solid var(--accent-color);
            padding-left: 8px;
        }
        
        /* h4 Title Style */
        .main-content h4 {
            color: var(--accent-color);
            font-size: 1.3em;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 5px;
            border-bottom: 1px dotted var(--accent-color);
        }
        
        code, .formula-block {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            display: block;
            overflow-x: auto;
            margin: 20px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.1em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }
        
        th {
            background-color: var(--code-bg);
        }

        /* --- Interactive Functionality Styles --- */
        
        .collapsible {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            font-weight: bold;
            color: var(--accent-color);
            border-bottom: 2px dotted var(--accent-color);
        }
        
        .collapsible-icon {
            margin-right: 8px;
            transition: transform 0.3s ease;
        }
        
        .collapsible-content {
            display: none;
            padding: 10px 0 10px 25px;
            border-left: 3px solid var(--border-color);
            margin-left: 5px;
            margin-top: 5px;
        }

        .mastery-controls {
            display: inline-flex;
            gap: 10px;
            margin-left: 15px;
            vertical-align: middle;
        }

        .mastery-icon {
            cursor: pointer;
            font-size: 1.4em;
            opacity: 0.3;
            transition: opacity 0.3s ease, transform 0.2s ease;
        }
        
        .mastery-icon:hover {
            transform: scale(1.2);
        }

        .mastery-icon.selected {
            opacity: 1;
        }
        
        .quiz-button {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        .quiz-button:hover {
            background-color: var(--primary-color);
        }
        
        .quiz-container {
            display: none; /* Default hidden, only show when content is present */
            margin-top: 20px;
            padding: 20px;
            background-color: rgba(247, 250, 252, 0.3); /* Lighter background */
            border: 1px solid rgba(226, 232, 240, 0.5); /* Lighter border */
            border-radius: 8px;
            position: relative; /* Provides a reference point for refresh button */
        }
        
        /* Section End Divider */
        .section-divider {
            margin: 60px 0 40px 0;
            text-align: center;
            position: relative;
        }
        
        .section-divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, var(--border-color) 20%, var(--accent-color) 50%, var(--border-color) 80%, transparent 100%);
        }
        
        .section-divider::after {
            content: '◆ ◆ ◆';
            background-color: var(--bg-color);
            color: var(--accent-color);
            padding: 0 20px;
            font-size: 1.2em;
            position: relative;
            z-index: 1;
        }
        
        /* Section Container Control */
        .section-container {
            display: none;
        }
        
        .section-container.active {
            display: block;
        }
        
        /* Section Navigation Buttons */
        .section-nav-button {
            display: block;
            margin: 40px auto 20px auto;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            min-width: 250px;
        }
        
        .section-nav-button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .section-nav-button:active {
            transform: translateY(0);
        }
        
        .quiz-item {
            margin-bottom: 20px;
        }
        
        .quiz-answer {
            display: none;
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid var(--accent-color);
        }

        .show-answer-btn {
            margin-left: 10px;
            padding: 5px 10px;
            border: 1px solid var(--accent-color);
            background: none;
            color: var(--accent-color);
            cursor: pointer;
            border-radius: 5px;
        }
        
        .quiz-refresh-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(113, 128, 150, 0.3);
        }
        
        .quiz-refresh-btn:hover {
            background-color: var(--primary-color);
            transform: rotate(180deg);
            box-shadow: 0 4px 12px rgba(113, 128, 150, 0.4);
        }

        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: var(--primary-color);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            text-align: center;
            line-height: 50px;
            font-size: 24px;
            text-decoration: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1001;
        }
        
        .back-to-top.show {
            opacity: 1;
            visibility: visible;
        }
        

        
        /* Left Touch Bar */
        .sidebar-trigger-strip {
            position: fixed;
            top: 0;
            left: 0;
            width: 25px;
            height: 100vh;
            z-index: 999;
            background: linear-gradient(90deg, rgba(74, 85, 104, 0.1) 0%, rgba(74, 85, 104, 0.05) 70%, transparent 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            /* Add visual hint */
            background-image: 
                radial-gradient(circle, rgba(74, 85, 104, 0.3) 1px, transparent 1px),
                radial-gradient(circle, rgba(74, 85, 104, 0.2) 1px, transparent 1px);
            background-size: 8px 20px, 8px 20px;
            background-position: 8px 10px, 8px 30px;
            background-repeat: repeat-y;
        }
        
        .sidebar-trigger-strip:hover {
            width: 30px;
            background: linear-gradient(90deg, rgba(74, 85, 104, 0.2) 0%, rgba(74, 85, 104, 0.1) 70%, transparent 100%);
        }
        
        /* Hide touch bar when sidebar is open */
        .sidebar.open ~ .sidebar-trigger-strip {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Responsive Layout */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            .main-content h1 { font-size: 2em; }
            .main-content h2 { font-size: 1.8em; }
            .main-content h3 { font-size: 1.4em; }
        }

        @media (min-width: 769px) {
            /* Desktop: when sidebar is open, push main content area */
            .sidebar.open ~ .main-content {
                margin-left: 280px;
            }
        }
    </style>
</head>
<body>
    <div class="lang-switch">
        <button onclick="window.location.href='index-zh.html'">中文</button>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">Digital & Analogue TA</div>
            <nav id="table-of-contents"></nav>
        </aside>

        <!-- Left Touch Bar -->
        <div class="sidebar-trigger-strip" id="sidebar-trigger-strip"></div>

        <main class="main-content" id="main-content-area">
            <h1>Digital & Analogue<br/>TA Review</h1>

            <!-- Notes content will be dynamically inserted here by JS -->

        </main>
    </div>

    <!-- Back to Top Button -->
    <a href="#" class="back-to-top" id="back-to-top-btn">↑</a>

    <script>
    // ---------------------------------------------------------------
    // ---------------------- Notes Content Data Source -------------------------
    // ---------------------------------------------------------------
    const notesContent = `
    <div class="section-container active" id="analogue-container">
    <section id="analogue-electronics" class="quiz-section">
        <h2>Analogue Electronics</h2>
        <section id="mosfet-operating-states-output-voltage-swing">
            <h3>MOSFET Operating States & Output Voltage Swing <div class="mastery-controls" data-id="mosfet-operating-states-output-voltage-swing"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <p>MOSFET has three basic operating states:</p>
            <ul>
                <li><strong>Off State</strong> - Like a closed switch, no current flows</li>
                <li><strong>Linear State</strong> - Like a variable resistor, current is controlled by gate voltage</li>
                <li><strong>Saturation State</strong> - Like a constant current source, provides a fixed current</li>
            </ul>
            <p><strong>Note</strong>: In the saturation state, there is a <span class="collapsible"><span class="collapsible-icon">[+]</span>Channel Length Modulation effect</span><span class="collapsible-content">which causes the drain voltage to increase slightly, resulting in a slight increase in current.</span> The current formula is:</p>
            <div class="formula-block">$$ I_D = \\frac{1}{2} \\mu_n C_{\\text{ox}} \\frac{W}{L} (V_{GS} - V_T)^2 (1 + \\lambda V_{DS}) $$</div>
            <p><span class="collapsible"><span class="collapsible-icon">[+]</span>Output Voltage Swing</span><span class="collapsible-content">is defined as the maximum voltage range when the amplifier works in all transistor saturation regions:</span></p>
            <ul>
                <li><strong>Upper Limit (Vout,max)</strong>: Limited by PMOS load transistor entering triode region, approximately VDD−∣VOV,load∣</li>
                <li><strong>Lower Limit (Vout,min)</strong>: Limited by NMOS pair or tail current source transistor entering triode region, approximately VOV,input+VOV,tail</li>
            </ul>
        </section>
        <section id="basic-principles-of-differential-amplifiers">
            <h3>Basic Principles of Differential Amplifiers <div class="mastery-controls" data-id="basic-principles-of-differential-amplifiers"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <h4>1. <span class="quiz-term">Differential Mode (A_dm)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="How does differential mode (A_dm) work?"><strong>Working Principle</strong>: The common source point shared by the two transistors in the differential amplifier can be considered as a "virtual ground" because the circuit is symmetrical.</span></li>
                <li><span class="quiz-definition" data-term="What is the simplified analysis method for differential mode (A_dm)?"><strong>Simplified Analysis Method</strong>: We can only analyze half of the circuit and treat it as a simple common-source amplifier to understand it, which makes the calculation easier.</span></li>
                <li><strong>Amplification Ability</strong>:
                    <ul>
                        <li><span class="quiz-definition" data-term="What is 'Single-ended Output Gain'?">When we only look at one output terminal, this is called "Single-ended Output Gain".</span></li>
                        <li><span class="quiz-definition" data-term="What is 'Differential Output Gain'?">When we look at the voltage difference between the two output terminals, this is called "Differential Output Gain". In most cases, the differential output gain is twice the single-ended output gain.</span></li>
                    </ul>
                </li>
            </ul>
            <h4>2. <span class="quiz-term">Common Mode (A_cm)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="How does common mode (A_cm) work?"><strong>Working Principle</strong>: When the same signal is received at both input terminals (common mode signal), the resistance of the tail current source plays an important role. This resistance produces a negative feedback effect to help suppress common mode signals.</span></li>
                <li><span class="quiz-definition" data-term="How effective is the common mode suppression?"><strong>Suppression Effect</strong>: The amplifier greatly attenuates common mode signals, which is exactly what we want.</span></li>
                <li><span class="quiz-definition" data-term="How does common mode (A_cm) perform in differential output?"><strong>Differential Output Performance</strong>: When we look at the difference between the two output terminals, ideally, the common mode signal is completely eliminated (gain is zero). This is because the common mode signal causes exactly the same change on both sides.</span></li>
            </ul>
            <h4>3. <span class="quiz-term">Common Mode Rejection Ratio (CMRR)</span></h4>
            <ul>
                <li><span class="quiz-definition" data-term="What does CMRR mean?"><strong>Meaning</strong>: CMRR is used to measure the quality of the amplifier, which represents the ratio of the amplifier's amplification ability for useful signals (differential signals) to its suppression ability for interference signals (common mode signals).</span></li>
            </ul>
            <div class="formula-block">$$ CMRR=\\left|\\frac{A_{dm}}{A_{cm}}\\right| $$</div>
            <ul>
                 <li><span class="quiz-definition" data-term="What do CMRR performance indicators represent?"><strong>Performance Indicators</strong>: The larger the CMRR, the better the performance. Especially in differential output, theoretically, CMRR can be infinitely large because common mode signals are completely suppressed.</span></li>
            </ul>
            <h4>The Role of Two Key Transistors in Amplifiers</h4>
            <ul>
                <li><span class="quiz-definition" data-term="What is the role of M1 transistor in the amplifier?"><strong>M1's Work: Signal Amplifier</strong> M1 is responsible for receiving and amplifying the input signal. It acts like a voltage-controlled switch, adjusting the current size according to the input voltage change. The transconductance (gm1) of M1 determines how small the voltage change can be converted into how large the current change.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of M3 transistor in the amplifier?"><strong>M3's Work: Current Converter</strong> M3's task is to convert the current change generated by M1 into a voltage change. Its gate voltage is fixed, and its main function is to provide a very large output resistance. This large resistance helps us obtain a larger output voltage signal.</span></li>
            </ul>
        </section>
        <section id="miller-effect">
            <h3>Miller Effect <div class="mastery-controls" data-id="miller-effect"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Miller Effect</span></span><span class="collapsible-content quiz-definition" data-term="Explain Miller Effect">Input-output capacitance (such as Cgd in CS amplifier) in an inverting amplifier is effectively larger at the input end, Cin,Miller=Cf(1−A_v), because Av is a large negative number.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Input Pole (Input Pole)</span></span><span class="collapsible-content quiz-definition" data-term="Explain Input Pole">The amplifier's frequency response is limited by the pole formed by the RC network, fp=1/(2πR_totalC_total).</span></li>
                <li><span class="quiz-definition" data-term="Why is Miller effect more pronounced in common source amplifiers?"><strong>Common Source (CS) Amplifier</strong>: Cgd capacitance between gate and drain causes significant Miller effect, forming the <strong>dominant pole</strong> limiting bandwidth.</span></li>
                <li><span class="quiz-definition" data-term="Why is Miller effect not present in common gate amplifiers?"><strong>Common Gate (CG) Amplifier</strong>: Input source, output drain, gate grounded, no input-output capacitance, therefore <strong>no Miller effect</strong>, higher frequency characteristics than CS.</span></li>
            </ul>
        </section>
        <section id="negative-feedback">
            <h3>Negative Feedback <div class="mastery-controls" data-id="negative-feedback"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <ul>
                <li><span class="quiz-definition" data-term="Describe a negative feedback method and its effect"><strong>Feedback Method</strong>: Series input, parallel output, improves input resistance, reduces output resistance.</span></li>
            </ul>
            <h4>Positive Feedback vs Negative Feedback</h4>
            <p>Determine feedback type by analyzing <strong>how feedback affects the input</strong>:</p>
            <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Negative Feedback</span></span><span class="collapsible-content quiz-definition" data-term="How does negative feedback work, and what is its effect?">Feedback signal <strong>cancels</strong> input changes, reducing effective input. <strong>Used to stabilize the circuit</strong>.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Positive Feedback</span></span><span class="collapsible-content quiz-definition" data-term="How does positive feedback work, and what is its effect?">Feedback signal <strong>strengthens</strong> input changes, increasing effective input. <strong>May cause oscillation</strong>.</span></li>
            </ul>
        </section>
        
        <!-- Analogue Electronics Main Chapter Quiz -->
        <button class="quiz-button">Generate Analogue Electronics Quiz</button>
        <div class="quiz-container"></div>
        
        <!-- Section End Divider -->
        <div class="section-divider"></div>
    </section>
    
    <!-- Button to jump to Digital Chapter -->
    <button class="section-nav-button" id="go-to-digital-btn">
        Enter Digital Electronics Chapter →
    </button>
    </div>
    
    <div class="section-container" id="digital-container">
    <!-- Button to return to Analogue Chapter -->
    <button class="section-nav-button" id="go-to-analogue-btn">
        ← Return to Analogue Electronics Chapter
    </button>
    
    <section id="digital-electronics" class="quiz-section">
        <h2>Digital Electronics</h2>
        <section id="logic-timing-power">
            <h3>Logic, Timing & Power<div class="mastery-controls" data-id="logic-timing-power"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <h4>Methodology of Logical Effort</h4>
            <p>This is a simple method to calculate the delay of digital circuits. Its main advantage is to break down complex delay problems into several simple parts for analysis.</p>
            <p>We use a formula to represent the delay of a circuit: d = g⋅h + p</p>
            <ul>
                <li><strong>Basic Components</strong>:
                    <ul>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">g (Logical Effort)</span></span><span class="collapsible-content quiz-definition" data-term="What is Logical Effort (g)?">Represents the delay caused by circuit type, such as the inherent difference between NAND and NOR gates</span></li>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">h (Electrical Effort)</span></span><span class="collapsible-content quiz-definition" data-term="What is Electrical Effort (h)?">Represents the delay caused by load size, simply put, the ratio of output capacitance to input capacitance</span></li>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">p (Parasitic Delay)</span></span><span class="collapsible-content quiz-definition" data-term="What is Parasitic Delay (p)?">Represents the inherent delay of the circuit, this part of the delay is independent of the load</span></li>
                    </ul>
                </li>
                <li><strong>Several Important Concepts</strong>:
                     <ul>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Gate Effort (f)</span></span><span class="collapsible-content quiz-definition" data-term="What is Gate Effort (f)?">This is the delay caused by the load, equal to the product of logical effort and electrical effort (f = g⋅h)</span></li>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Normalized Delay (d)</span></span><span class="collapsible-content quiz-definition" data-term="What is Normalized Delay (d)?">This is the total delay of the circuit, expressed in relative units. It equals gate effort plus parasitic delay (d = f + p)</span></li>
                        <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Actual Delay (propagation Delay, tpd)</span></span><span class="collapsible-content quiz-definition" data-term="What is Actual Delay (tpd)?">If you want to know the actual delay time (in seconds), you just need to multiply the normalized delay by a time constant τ related to the process: tpd = d⋅τ</span></li>
                    </ul>
                </li>
            </ul>
             <h4>Summary Table of Boolean Algebra's Three Laws</h4>
             <table>
                <thead><tr><th><strong>Absorption Law</strong></th><th>Formula</th><th>Explanation</th></tr></thead>
                <tbody>
                    <tr><td> </td><td>A+AB=A</td><td>If A is already present, no need to add a term containing A</td></tr>
                    <tr><td> </td><td>A(A+B)=A</td><td>Multiplying A by a term containing A results in A</td></tr>
                    <tr><td> </td><td>A+A′B=A+B</td><td>Can be simplified to A+B (A' means NOT A)</td></tr>
                </tbody>
             </table>
             <h4>Switching Power</h4>
             <ul>
                 <li><strong>Switching Power Formula</strong>: Switching power is represented by the following formula:</li>
             </ul>
             <div class="formula-block">$$ P_{SW} = \\alpha \\cdot f \\cdot C_L \\cdot V_{DD}^2 $$</div>
             <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span>Formula Parameter Explanation</span><span class="collapsible-content"><ul><li>PSW: Switching Power, unit is Watt (W).</li><li>α: <strong>Activity Factor</strong>, represents the probability that a charge/discharge conversion occurs within each clock cycle, which is an dimensionless parameter ranging from 0 to 1.</li><li>f: Clock Frequency, unit is Hertz (Hz).</li><li>CL: Load Capacitance, unit is Farad (F).</li><li>VDD: Supply Voltage, unit is Volt (V).</li></ul></span></li>
             </ul>
             <h4>Various Types of Logic Circuits</h4>
             <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Static Logic (Static Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Static Logic (Static Logic)?">The most basic type of logic circuit. It does not require a clock signal to control, and maintains stable output through fixed pull-up and pull-down circuits.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Pass Transistor Logic (Pass Transistor Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Pass Transistor Logic (Pass Transistor Logic)?">Uses transistors as simple switches to transmit signals. The structure is simple, but the high-level signal transmission will have some attenuation.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Pseudo-NMOS Logic (Pseudo-NMOS Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Pseudo-NMOS Logic (Pseudo-NMOS Logic)?">A simplified version of static logic circuit. It uses a permanently conductive pull-up resistor, the structure is simple but consumes some static power.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Ratioed Logic (Ratioed Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Ratioed Logic (Ratioed Logic)?">The output result depends on the size ratio of the pull-up and pull-down transistors. It can be imagined as two transistors "pulling" each other, who is stronger determines whether the output is high or low.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Dynamic Logic (Dynamic Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Dynamic Logic (Dynamic Logic)?">Circuits controlled by clock signals. The work is divided into two stages: first pre-charge (charge the output to high level), then based on the input signal, decide whether to maintain high level or discharge to low level.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Domino Logic (Domino Logic)</span></span><span class="collapsible-content quiz-definition" data-term="What is Domino Logic (Domino Logic)?">An improved version of dynamic logic, adding a signal flip-flop at the output end to make the circuit work better in series.</span></li>
             </ul>
             <h4>Timing Delays</h4>
             <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Contamination Delay (tcd)</span></span><span class="collapsible-content quiz-definition" data-term="What is Contamination Delay (tcd)?">The shortest time for signal transmission. That is, after the input changes, how long does it take for the output to start changing.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Propagation Delay (Propagation Delay, tpd)</span></span><span class="collapsible-content quiz-definition" data-term="What is Propagation Delay (tpd)?">The longest time for signal transmission. That is, after the input changes, how long does it take for the output to fully stabilize.</span></li>
             </ul>
        </section>
        <section id="physical-design-verification">
            <h3>Physical Design & Verification <div class="mastery-controls" data-id="physical-design-verification"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <h4>Post-layout Simulation Layout Post-layout Simulation & Extraction Extraction</h4>
            <ul>
                <li><span class="quiz-definition" data-term="Brief Description of Layout Design Process"><strong>Design Flow</strong>: Schematic Design → Layout Design → Extraction → Verification & Simulation</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Extraction (Extraction)</span></span><span class="collapsible-content quiz-definition" data-term="What is Extraction?">CAD tools automatically analyze the layout, identify circuit elements and connections, and generate <strong>netlist</strong>. Need to identify <strong>vias</strong> to understand circuit connections.</span></li>
                <li><span class="quiz-definition" data-term="What are parasitic parameters?"><strong>Parasitic</strong>: In actual layouts, parasitic resistance and parasitic capacitance (<strong>parasitic resistance/capacitance</strong>) will be generated, which are unavoidable.</span></li>
                <li><strong>Accurate Simulation (Accurate Simulation)</strong>:
                    <ul>
                        <li><span class="quiz-definition" data-term="What are the characteristics of Pre-layout simulation?"><strong>Pre-layout</strong>: Based on ideal circuit diagrams, fast but not accurate.</span></li>
                        <li><span class="quiz-definition" data-term="What are the characteristics of Post-layout simulation?"><strong>Post-layout</strong>: Includes parasitic parameters, results are more accurate, closer to actual chip performance.</span></li>
                    </ul>
                </li>
            </ul>
            <h4>Core Layout Techniques</h4>
            <ul>
                <li><span class="quiz-definition" data-term="What is the role of Guard Ring?"><strong>Guard Ring (Guard Ring)</strong>: Increases area, used to prevent latch-up.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of H-Tree or Spine?"><strong>H-Tree or Spine (H-Tree or Spine)</strong>: Used to reduce clock skew.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of Striped Metal Layers?"><strong>Striped Metal Layers (Striped Metal Layers)</strong>: Used to uniformly distribute power, reduce IR voltage drop.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of Increased track width?"><strong>Increased track width (Increased track width)</strong>: Used to reduce resistance or improve current carrying capacity.</span></li>
                <li><span class="quiz-definition" data-term="What is the role of Folded Layout?"><strong>Folded Layout (Folded Layout)</strong>: Significantly <strong>reduces cell area</strong>.</span></li>
            </ul>
        </section>
        <section id="design-for-testability-dft">
            <h3>Design for Testability<div class="mastery-controls" data-id="design-for-testability-dft"><span class="mastery-icon" data-level="mastered">😊</span><span class="mastery-icon" data-level="review">🤔</span><span class="mastery-icon" data-level="confused">🤯</span></div></h3>
            <h4>Scan Path (Scan Path flip-flop)</h4>
            <ol>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Implement Static Characteristics</span></span><span class="collapsible-content quiz-definition" data-term="How to solve the problem of latching data to implement static characteristics?"><strong>Problem</strong>: Latching with transmission gates will leak data. <br><strong>Solution</strong>: Add feedback circuits to maintain data stability.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Implement Edge Sensitivity</span></span><span class="collapsible-content quiz-definition" data-term="How to implement edge sensitivity using latches?"><strong>Problem</strong>: Ordinary latches do not update data accurately enough. <br><strong>Solution</strong>: Use two-stage latches: <ul><li>High level: First stage receives data, second stage maintains;</li><li>Fall edge: First stage latches data, second stage updates.</li></ul></span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Prevent Voltage Shock (ESD Protection)</span></span><span class="collapsible-content quiz-definition" data-term="How does ESD protection circuit work?"><strong>Function</strong>: Circuitry to protect chip pins. <br><strong>Working Method</strong>: <ul><li>Use an inverter at input D;</li><li>When high voltage, diodes conduct to pass large current.</li></ul></span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Improve Work Speed (Reduce Setup Time)</span></span><span class="collapsible-content quiz-definition" data-term="How to improve the trigger to reduce setup time?"><strong>Problem</strong>: MUX selector makes the trigger slower. <br><strong>Improvement Method</strong>: Integrate function into transmission gates to improve speed.</span></li>
            </ol>
            <h4>"Bed of Nails Test" (Bed of Nails Test)</h4>
             <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Basic Concept</span></span><span class="collapsible-content quiz-definition" data-term="What is 'Bed of Nails Test'?">This is a traditional testing method used to check if components on a circuit board are soldered well. When testing, a device with many test pins is needed, and these pins will contact specially reserved test points on the circuit board.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Disadvantages</span></span><span class="collapsible-content quiz-definition" data-term="What are the disadvantages of 'Bed of Nails Test'?">Nowadays, chip packages are becoming increasingly dense (e.g., BGA packages), making it difficult to test using this method, which is why new technologies like boundary scan are needed.</span></li>
             </ul>
            <h4>Boundary Scan</h4>
             <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Testing Difficulties</span></span><span class="collapsible-content quiz-definition" data-term="What are the difficulties of modern chip testing?">Modern chips are becoming smaller and smaller, making it difficult to test if the connections between chips are normal using traditional methods.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Solution</span></span><span class="collapsible-content quiz-definition" data-term="How does boundary scan solve the testing difficulties?">Add a <strong>boundary scan cell</strong> to each input/output pin of the chip. These cells are connected in a chain, forming a test path that wraps around the chip core. </span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Working Method</span></span><span class="collapsible-content quiz-definition" data-term="How does boundary scan work?">We can check if the chip pins are working normally through a standard <strong>test access port (Test Access Port, TAP)</strong>, without directly contacting the chip.</span></li>
             </ul>
            <h4>Built-In Self-Test (BIST)</h4>
            <ul>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Main Implementation</span></span><span class="collapsible-content quiz-definition" data-term="What is the main idea of Built-In Self-Test (BIST)?">Let the chip <strong>"test itself"</strong>, so it does not need too many expensive external testing devices.</span></li>
                <li><span class="collapsible"><span class="collapsible-icon">[+]</span><span class="quiz-term">Main Components</span></span><span class="collapsible-content quiz-definition" data-term="What are the main components of Built-In Self-Test (BIST)?"><ol><li><strong>Test Signal Generator</strong>: Automatically generates test signals.</li><li><strong>Result Analyzer</strong>: Converts test results into a simple digital feature code.</li></ol></span></li>
                <li><span class="quiz-definition" data-term="What is BILBO technology?"><strong>BILBO technology</strong> is a special self-test module that integrates multiple test functions, capable of automatically completing the test and analyzing the results.</span></li>
            </ul>
        </section>
        
        <!-- Digital Electronics Main Chapter Quiz -->
        <button class="quiz-button">Generate Digital Electronics Quiz</button>
        <div class="quiz-container"></div>
        
        <!-- Section End Divider -->
        <div class="section-divider"></div>
    </section>
    </div>
    `;

    document.addEventListener('DOMContentLoaded', function() {
        
        const mainContentArea = document.getElementById('main-content-area');
        // Inject notes content
        mainContentArea.innerHTML += notesContent;
        
        // ---------------------------------------------------------------
        // ---------------------- Functionality Implementation Logic ---------------------------
        // ---------------------------------------------------------------

        function generateTableOfContents() {
            const tocContainer = document.getElementById('table-of-contents');
            const mainContent = document.getElementById('main-content-area');
            // Find all sections, including hidden containers
            const topLevelSections = mainContent.querySelectorAll('section[id$="-electronics"]');
            let tocHtml = '<ul>';

            topLevelSections.forEach(section => {
                const h2 = section.querySelector('h2');
                if (!h2) return;

                const h2Id = section.id;
                const h2Title = h2.textContent;
                tocHtml += `<li><a href="#${h2Id}" onclick="navigateToSection('${h2Id}')">${h2Title}</a>`;

                const subSections = section.querySelectorAll('section');
                if (subSections.length > 0) {
                    tocHtml += '<ul class="sub-menu">';
                    subSections.forEach(subSection => {
                        const h3 = subSection.querySelector('h3');
                        if (h3) {
                            const h3Id = subSection.id;
                            const h3Title = h3.firstChild.textContent.trim(); 
                            tocHtml += `<li><a href="#${h3Id}" onclick="navigateToSection('${h3Id}')">${h3Title}</a></li>`;
                        }
                    });
                    tocHtml += '</ul>';
                }
                tocHtml += '</li>';
            });

            tocHtml += '</ul>';
            tocContainer.innerHTML = tocHtml;
        }

        function initializeCollapsibles() {
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(item => {
                item.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const icon = this.querySelector('.collapsible-icon');
                    
                    if (content.style.display === "block") {
                        content.style.display = "none";
                        icon.textContent = "[+]";
                        icon.style.transform = "rotate(0deg)";
                    } else {
                        content.style.display = "block";
                        icon.textContent = "[-]";
                        icon.style.transform = "rotate(90deg)";
                    }
                });
            });
        }
        
        function initializeMasteryControls() {
            const controls = document.querySelectorAll('.mastery-controls');
            controls.forEach(control => {
                const id = control.dataset.id;
                const icons = control.querySelectorAll('.mastery-icon');
                
                const savedState = localStorage.getItem('mastery-' + id);
                if (savedState) {
                    const savedIcon = control.querySelector(`[data-level='${savedState}']`);
                    if(savedIcon) savedIcon.classList.add('selected');
                }
                
                icons.forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const level = this.dataset.level;
                        icons.forEach(i => i.classList.remove('selected'));
                        if (localStorage.getItem('mastery-' + id) === level) {
                             localStorage.removeItem('mastery-' + id);
                        } else {
                            this.classList.add('selected');
                            localStorage.setItem('mastery-' + id, level);
                        }
                    });
                });
            });
        }

        function initializeQuizButtons() {
            const quizButtons = document.querySelectorAll('.quiz-button');
            quizButtons.forEach(button => {
                // Initialize button state
                button.dataset.state = 'generate';
                
                button.addEventListener('click', function() {
                    const section = this.closest('.quiz-section');
                    const quizContainer = section.querySelector('.quiz-container');
                    
                    if (this.dataset.state === 'generate') {
                        // Generate quiz
                        generateQuizContent(section, this);
                        this.textContent = 'Close Quiz';
                        this.dataset.state = 'close';
                    } else {
                        // Close quiz
                        quizContainer.style.display = 'none';
                        quizContainer.innerHTML = '';
                        this.textContent = 'Generate Chapter Quiz';
                        this.dataset.state = 'generate';
                    }
                });
            });
        }

        function generateQuizContent(section, button) {
            const quizContainer = section.querySelector('.quiz-container');
            const terms = section.querySelectorAll('.quiz-definition');
            
            if (terms.length === 0) {
                quizContainer.innerHTML = `
                    <button class="quiz-refresh-btn" title="Refresh Quiz">↻</button>
                    <h4>Self-Test for This Chapter</h4>
                    <p>No quiz questions available for this chapter.</p>
                `;
                quizContainer.style.display = 'block';
                return;
            }

            const shuffledTerms = Array.from(terms).sort(() => 0.5 - Math.random());
            const selectedTerms = shuffledTerms.slice(0, Math.min(shuffledTerms.length, 5)); 

            let quizHtml = `
                <button class="quiz-refresh-btn" title="Refresh Quiz">↻</button>
                <h4>Self-Test for This Chapter</h4>
            `;
            selectedTerms.forEach((term, index) => {
                const question = term.dataset.term || 'Please explain...';
                const answer = term.innerHTML;
                quizHtml += `
                    <div class="quiz-item">
                        <p>${index + 1}. ${question}
                            <button class="show-answer-btn">Show Answer</button>
                        </p>
                        <div class="quiz-answer">${answer}</div>
                    </div>
                `;
            });
            quizContainer.innerHTML = quizHtml;
            quizContainer.style.display = 'block';

            // Set show answer button event
            quizContainer.querySelectorAll('.show-answer-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const answerDiv = this.parentElement.nextElementSibling;
                    answerDiv.style.display = 'block';
                    this.style.display = 'none';
                });
            });

            // Set refresh button event
            const refreshBtn = quizContainer.querySelector('.quiz-refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    generateQuizContent(section, button);
                });
            }
        }



        // Chapter switching functionality
        function showDigital() {
            console.log('Switching to Digital Chapter'); // Debug info
            const analogueContainer = document.getElementById('analogue-container');
            const digitalContainer = document.getElementById('digital-container');
            
            if (analogueContainer && digitalContainer) {
                analogueContainer.classList.remove('active');
                digitalContainer.classList.add('active');
                window.scrollTo(0, 0);
                updateActiveNavigation('digital-electronics');
            } else {
                console.error('Could not find container elements');
            }
        }

        function showAnalogue() {
            console.log('Switching to Analogue Chapter'); // Debug info
            const analogueContainer = document.getElementById('analogue-container');
            const digitalContainer = document.getElementById('digital-container');
            
            if (analogueContainer && digitalContainer) {
                digitalContainer.classList.remove('active');
                analogueContainer.classList.add('active');
                window.scrollTo(0, 0);
                updateActiveNavigation('analogue-electronics');
            } else {
                console.error('Could not find container elements');
            }
        }

        function updateActiveNavigation(sectionId) {
            // Update navigation bar current active state
            const navLinks = document.querySelectorAll('#table-of-contents a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + sectionId) {
                    link.classList.add('active');
                }
            });
        }

        function navigateToSection(sectionId) {
            // Navigation click handler function
            if (sectionId === 'analogue-electronics' || sectionId.includes('mosfet') || 
                sectionId.includes('differential') || sectionId.includes('miller') || 
                sectionId.includes('negative-feedback')) {
                // Belongs to analogue chapter
                if (!document.getElementById('analogue-container').classList.contains('active')) {
                    showAnalogue();
                }
            } else if (sectionId === 'digital-electronics' || sectionId.includes('logic') || 
                       sectionId.includes('physical') || sectionId.includes('testability')) {
                // Belongs to digital chapter
                if (!document.getElementById('digital-container').classList.contains('active')) {
                    showDigital();
                }
            }
            
            // Delay scrolling to ensure the section is displayed
            setTimeout(() => {
                const targetElement = document.getElementById(sectionId);
                if (targetElement) {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                updateActiveNavigation(sectionId);
            }, 100);
        }

        function initializeBackToTopButton() {
            const backToTopBtn = document.getElementById('back-to-top-btn');
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
        }
        
        function initializeActiveNavHighlighting() {
             const sections = document.querySelectorAll('main section[id]');
             const navLinks = document.querySelectorAll('#table-of-contents a');

             const observer = new IntersectionObserver((entries) => {
                 entries.forEach(entry => {
                     if (entry.isIntersecting) {
                         navLinks.forEach(link => {
                             link.classList.remove('active');
                             if (link.getAttribute('href').substring(1) === entry.target.id) {
                                 link.classList.add('active');
                             }
                         });
                     }
                 });
             }, { rootMargin: "-50% 0px -50% 0px" });

             sections.forEach(section => {
                 observer.observe(section);
             });
        }

        /**
         * Function 7: Sidebar Behavior Initialization
         * [UPDATED] Integrates both hover and click behaviors for mobile devices
         */
                 function initializeSectionNavigation() {
            // Initialize chapter jump buttons
            const goToDigitalBtn = document.getElementById('go-to-digital-btn');
            const goToAnalogueBtn = document.getElementById('go-to-analogue-btn');
            
            if (goToDigitalBtn) {
                goToDigitalBtn.addEventListener('click', showDigital);
            }
            
            if (goToAnalogueBtn) {
                goToAnalogueBtn.addEventListener('click', showAnalogue);
            }
        }

         function initializeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const triggerStrip = document.getElementById('sidebar-trigger-strip');
            const mainContent = document.getElementById('main-content-area');

            // Mobile: Click touch bar to expand
            triggerStrip.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('open');
                }
            });

            // Desktop: Hover touch bar to show
            triggerStrip.addEventListener('mouseenter', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.add('open');
                }
            });

            // Desktop: Hide sidebar after mouse leaves
            sidebar.addEventListener('mouseleave', () => {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('open');
                }
            });

            // Mobile: Click main content area to hide
            mainContent.addEventListener('click', () => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                }
            });

            // Mobile: Click navigation links to hide
            sidebar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                     if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                     }
                     // Prevent default anchor jump, use custom navigation
                     e.preventDefault();
                     const href = link.getAttribute('href');
                     if (href && href.startsWith('#')) {
                         const sectionId = href.substring(1);
                         navigateToSection(sectionId);
                     }
                });
            });
        }

        // ---------------------------------------------------------------
        // ---------------------- Initialize All Functions -------------------------
        // ---------------------------------------------------------------
        
        generateTableOfContents();
        initializeCollapsibles();
        initializeMasteryControls();
        initializeQuizButtons();
        initializeBackToTopButton();
        initializeActiveNavHighlighting();
        initializeSidebar(); // Updated this function call
        initializeSectionNavigation(); // Initialize chapter navigation buttons

        // Render LaTeX formulas
        if (window.MathJax) {
            window.MathJax.typeset();
        }
    });
    </script>
</body>
</html>

